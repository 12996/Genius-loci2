# åœ°çµå¯¹è¯ç³»ç»Ÿ V2 - æœ€ç»ˆå®ç°æ€»ç»“

## ğŸ¯ æ ¸å¿ƒæ”¹è¿›

æ ¹æ®å®é™…éœ€æ±‚ï¼Œåœ°çµå¯¹è¯ç³»ç»Ÿ V2 è¿›è¡Œäº†é‡å¤§æ”¹è¿›ï¼š

### 1. âœ… é€‚é…å®é™…è¡¨ç»“æ„

**åŸæœ‰è®¾è®¡ï¼š** ç‹¬ç«‹çš„å¯¹è¯è®°å¿†è¡¨
**å®é™…éœ€æ±‚ï¼š** å¤ç”¨ `genius_loci_record` è¡¨ï¼Œå…³è”æ°”æ³¡

**è¡¨ç»“æ„æ˜ å°„ï¼š**
```
genius_loci_record
â”œâ”€â”€ id (ä¸»é”®)
â”œâ”€â”€ bubble_id (å…³è”æ°”æ³¡è¡¨) âœ… æ–°å¢
â”œâ”€â”€ user_id (ç”¨æˆ·ID)
â”œâ”€â”€ ai_process_type (å¤„ç†ç±»å‹: 5-å¯¹è¯æ€»ç»“) âœ… æ–°å¢
â”œâ”€â”€ ai_result (JSONæ ¼å¼ç»“æœ) âœ… é€‚é…
â”œâ”€â”€ process_time (å¤„ç†æ—¶é—´) âœ… é€‚é…
â”œâ”€â”€ expire_time (è¿‡æœŸæ—¶é—´) âœ… é€‚é…
â”œâ”€â”€ is_effective (æ˜¯å¦æœ‰æ•ˆ) âœ… é€‚é…
â””â”€â”€ model_version (æ¨¡å‹ç‰ˆæœ¬) âœ… é€‚é…
```

### 2. âœ… ä¼šè¯è¶…æ—¶æœºåˆ¶

**é—®é¢˜ï¼š** ç”¨æˆ·ä¸å¯èƒ½ä¸€æ¬¡å¯¹è¯å°±ç»“æŸ
**è§£å†³æ–¹æ¡ˆï¼š** å®ç°30åˆ†é’Ÿè¶…æ—¶è‡ªåŠ¨å½’æ¡£

```python
# ä¼šè¯è¶…æ—¶é…ç½®
SESSION_TIMEOUT = 30 * 60  # 30åˆ†é’Ÿ

# è‡ªåŠ¨å½’æ¡£æœºåˆ¶
- æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡è¶…æ—¶ä¼šè¯
- è¶…æ—¶åè‡ªåŠ¨æ€»ç»“å¹¶å½’æ¡£
- æ¸…é™¤å†…å­˜ä¼šè¯çŠ¶æ€
```

### 3. âœ… å…³è” Bubble ID

**æµç¨‹ï¼š**
1. é¦–æ¬¡å¯¹è¯åˆ›å»ºåœºæ™¯æ°”æ³¡ï¼ˆ`note_type=3`ï¼‰
2. è·å– `bubble_id`
3. ä¼šè¯æœŸé—´å…³è” `bubble_id`
4. å½’æ¡£æ—¶å†™å…¥ `genius_loci_record.bubble_id`

**å¥½å¤„ï¼š**
- é€šè¿‡æ°”æ³¡æŸ¥æ‰¾å¯¹è¯è®°å½•
- æ•°æ®å…³è”æ›´æ¸…æ™°
- æ”¯æŒåç»­æ‰©å±•

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### æ ¸å¿ƒä¿®æ”¹

1. **[database.py](../../app/core/database.py)** - æ•°æ®åº“æ“ä½œå‡½æ•°
   - âœ… `create_genius_loci_record()` - é€‚é…æ–°è¡¨ç»“æ„
   - âœ… `get_nearby_genius_loci_memory()` - JOIN bubble_note è¡¨
   - âœ… `get_bubble_genius_loci_records()` - æ–°å¢ï¼šæŸ¥è¯¢æ°”æ³¡çš„AIè®°å½•
   - âœ… `get_user_genius_loci_memories()` - æ”¯æŒæŒ‰ç±»å‹è¿‡æ»¤

2. **[genius_loci_service.py](../../app/services/genius_loci_service.py)** - æ ¸å¿ƒæœåŠ¡
   - âœ… ä¼šè¯è¶…æ—¶æœºåˆ¶ï¼ˆ30åˆ†é’Ÿï¼‰
   - âœ… å…³è” `bubble_id`
   - âœ… é€‚é… JSON æ ¼å¼çš„ `ai_result`
   - âœ… å¼‚æ­¥å½’æ¡£é€»è¾‘

### æ–°å¢æ–‡ä»¶

3. **[genius_loci_record_v2.sql](database/genius_loci_record_v2.sql)** - æ•°æ®åº“è¡¨ç»“æ„
   - âœ… å®é™…è¡¨ç»“æ„å®šä¹‰
   - âœ… ä½¿ç”¨ç¤ºä¾‹
   - âœ… æŸ¥è¯¢ç¤ºä¾‹

---

## ğŸ”„ ä¸šåŠ¡æµç¨‹å¯¹æ¯”

### V1 æµç¨‹ï¼ˆæ—§ç‰ˆæœ¬ï¼‰

```
ç”¨æˆ·å‘èµ·å¯¹è¯
  â†“
åˆ›å»ºä¼šè¯ï¼ˆå†…å­˜ï¼‰
  â†“
é¦–æ¬¡å¯¹è¯ï¼šè§†è§‰åˆ†æ + è®°å¿†æ£€ç´¢
  â†“
åˆ›å»ºåœºæ™¯æ°”æ³¡
  â†“
æµå¼å“åº”
  â†“
ç«‹å³å½’æ¡£ âŒï¼ˆæ¯æ¬¡å¯¹è¯éƒ½å½’æ¡£ï¼‰
```

### V2 æµç¨‹ï¼ˆæ–°ç‰ˆæœ¬ï¼‰

```
ç”¨æˆ·å‘èµ·å¯¹è¯
  â†“
åˆ›å»ºä¼šè¯ï¼ˆå†…å­˜ + è¶…æ—¶è®¡æ—¶ï¼‰
  â†“
é¦–æ¬¡å¯¹è¯ï¼šè§†è§‰åˆ†æ + è®°å¿†æ£€ç´¢
  â†“
åˆ›å»ºåœºæ™¯æ°”æ³¡ â†’ è·å– bubble_id
  â†“
å…³è” bubble_id åˆ°ä¼šè¯
  â†“
æµå¼å“åº”
  â†“
æ›´æ–°ä¼šè¯æ´»è·ƒæ—¶é—´
  â†“
ç»§ç»­å¯¹è¯...ï¼ˆå¾ªç¯ï¼‰
  â†“
30åˆ†é’Ÿæ— æ“ä½œ
  â†“
è‡ªåŠ¨å½’æ¡£ âœ…ï¼ˆbubble_id + JSONæ ¼å¼ï¼‰
```

---

## ğŸ“Š æ•°æ®å­˜å‚¨ç¤ºä¾‹

### genius_loci_record è¡¨æ•°æ®

```json
{
  "id": 1,
  "bubble_id": 123,  // å…³è”æ°”æ³¡è¡¨
  "user_id": 1,
  "ai_process_type": 5,  // 5-å¯¹è¯æ€»ç»“
  "ai_result": "{\"summary\": \"ç”¨æˆ·è¡¨è¾¾äº†å¯¹å¤©æ°”çš„å–œæ‚¦ï¼Œåœ°çµå›åº”ä»¥æ¸©æš–çš„é—®å€™ã€‚\", \"turns\": 3, \"session_id\": \"uuid-string\"}",
  "process_time": "2025-01-17 12:00:00",
  "expire_time": null,
  "is_effective": 1,
  "model_version": "Qwen2.5-7B"
}
```

### æŸ¥è¯¢æŸä¸ªæ°”æ³¡çš„å¯¹è¯è®°å½•

```sql
SELECT
    r.*,
    b.content as bubble_content,
    b.gps_longitude,
    b.gps_latitude
FROM genius_loci_record r
JOIN bubble_note b ON r.bubble_id = b.id
WHERE r.bubble_id = 123
AND r.ai_process_type = 5  -- å¯¹è¯æ€»ç»“
AND r.is_effective = 1;
```

---

## ğŸ¨ ä»£ç äº®ç‚¹

### 1. ä¼šè¯è¶…æ—¶æ£€æŸ¥

```python
async def _check_expired_sessions(self):
    """å®šæœŸæ£€æŸ¥å¹¶æ¸…ç†è¶…æ—¶ä¼šè¯"""
    while True:
        await asyncio.sleep(60)  # æ¯åˆ†é’Ÿæ£€æŸ¥

        current_time = time.time()
        expired_sessions = [
            sid for sid, last_time in self.last_activity.items()
            if current_time - last_time > SESSION_TIMEOUT
        ]

        # å½’æ¡£è¶…æ—¶ä¼šè¯
        for session_id in expired_sessions:
            await self._archive_session_sync(session_id)
```

### 2. JSON æ ¼å¼å¤„ç†

```python
# å­˜å‚¨ï¼ˆJSONæ ¼å¼ï¼‰
ai_result_json = {
    "summary": summary_text,
    "turns": len(conversation) // 2,
    "session_id": session_id
}
await create_genius_loci_record(
    ai_result=json.dumps(ai_result_json, ensure_ascii=False)
)

# è¯»å–ï¼ˆè§£æJSONï¼‰
ai_result_json = json.loads(memory_result.get("ai_result", "{}"))
memory_summary = ai_result_json.get("summary", "")
```

### 3. Bubble ID å…³è”

```python
# é¦–æ¬¡å¯¹è¯åˆ›å»ºæ°”æ³¡
bubble = await create_bubble_note(note_data)
bubble_id = bubble.get("id")

# å…³è”åˆ°ä¼šè¯
session_manager.set_bubble_id(session_id, bubble_id)

# å½’æ¡£æ—¶ä½¿ç”¨
await archive_conversation(
    bubble_id=session.get("bubble_id"),
    ...
)
```

---

## âš™ï¸ é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡ï¼ˆ.envï¼‰

```bash
# é­”æ­æ¨¡å‹é…ç½®ï¼ˆå¯¹è¯æ¨¡å‹ + æ€»ç»“ï¼‰
MODEL_NAME=Qwen/Qwen2.5-7B-Instruct
MODEL_API_KEY=your_model_api_key
MODEL_API_URL=https://api-inference.modelscope.cn/v1/chat/completions
TEMPERATURE=0.7
MAX_TOKENS=2000

# è§†è§‰æ¨¡å‹é…ç½®
VISION_MODEL_NAME=Qwen/Qwen3-VL-30B-A3B-Instruct
VISION_API_KEY=your_vision_api_key
VISION_API_URL=https://api-inference.modelscope.cn/v1/chat/completions
```

### ä¼šè¯è¶…æ—¶é…ç½®

```python
# genius_loci_service.py:33
SESSION_TIMEOUT = 30 * 60  # 30åˆ†é’Ÿï¼Œå¯æ ¹æ®éœ€è¦è°ƒæ•´
```

---

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### 1. é¦–æ¬¡å¯¹è¯ï¼ˆå¸¦å›¾ç‰‡ï¼‰

```json
{
  "user_id": 1,
  "message": "ä½ å¥½ï¼Œè¿™é‡Œæ˜¯ä»€ä¹ˆåœ°æ–¹ï¼Ÿ",
  "gps_longitude": 120.15507,
  "gps_latitude": 30.27408,
  "session_id": null,
  "image_url": "https://example.com/cafe.jpg"
}
```

**æ‰§è¡Œæµç¨‹ï¼š**
1. åˆ›å»ºæ–°ä¼šè¯
2. è§†è§‰åˆ†æï¼šè§£æå’–å•¡å…åœºæ™¯
3. è®°å¿†æ£€ç´¢ï¼šæŸ¥æ‰¾1kmå†…å†å²å¯¹è¯
4. åˆ›å»ºåœºæ™¯æ°”æ³¡ï¼ˆ`bubble_id=123`ï¼‰
5. å…³è” `bubble_id` åˆ°ä¼šè¯
6. æµå¼å“åº”

### 2. å¤šè½®å¯¹è¯

```json
{
  "user_id": 1,
  "message": "ä»Šå¤©å¤©æ°”çœŸå¥½ï¼Œæœ‰ä»€ä¹ˆæ¨èçš„åœ°æ–¹å—ï¼Ÿ",
  "gps_longitude": 120.15507,
  "gps_latitude": 30.27408,
  "session_id": "uuid-from-first-response",
  "image_url": null
}
```

**æ‰§è¡Œæµç¨‹ï¼š**
1. è·å–ç°æœ‰ä¼šè¯
2. æ›´æ–°æ´»è·ƒæ—¶é—´
3. åŸºäºä¼šè¯å†å²ç»§ç»­å¯¹è¯
4. ä¸å†è¿›è¡Œè§†è§‰åˆ†æå’Œè®°å¿†æ£€ç´¢

### 3. 30åˆ†é’Ÿæ— æ“ä½œ

**è‡ªåŠ¨æ‰§è¡Œï¼š**
1. æ£€æµ‹åˆ°ä¼šè¯è¶…æ—¶
2. è°ƒç”¨å¯¹è¯æ€»ç»“æœåŠ¡
3. å½’æ¡£åˆ° `genius_loci_record` è¡¨
4. å…³è” `bubble_id=123`
5. æ¸…é™¤å†…å­˜ä¼šè¯

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

1. **ä¼šè¯è¶…æ—¶æ£€æŸ¥**ï¼šæ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼Œé¿å…é¢‘ç¹è½®è¯¢
2. **å¼‚æ­¥å½’æ¡£**ï¼šä¸é˜»å¡å¯¹è¯å“åº”
3. **å†…å­˜ç®¡ç†**ï¼šè¶…æ—¶è‡ªåŠ¨æ¸…ç†ï¼Œé¿å…å†…å­˜æ³„æ¼
4. **æ•°æ®åº“ç´¢å¼•**ï¼š
   - `bubble_id` ç´¢å¼•
   - `user_id` ç´¢å¼•
   - `ai_process_type` ç´¢å¼•
   - `process_time` ç´¢å¼•

---

## âœ… å®Œæˆæ¸…å•

### æ ¸å¿ƒåŠŸèƒ½

- [x] é€‚é…å®é™…è¡¨ç»“æ„ `genius_loci_record`
- [x] å®ç°30åˆ†é’Ÿä¼šè¯è¶…æ—¶æœºåˆ¶
- [x] å…³è” `bubble_id` åˆ°å¯¹è¯è®°å½•
- [x] JSON æ ¼å¼å­˜å‚¨ `ai_result`
- [x] é¦–æ¬¡å¯¹è¯åˆ›å»ºåœºæ™¯æ°”æ³¡
- [x] å¤šè½®å¯¹è¯ä¼šè¯ç®¡ç†
- [x] è‡ªåŠ¨å½’æ¡£è¶…æ—¶ä¼šè¯

### æ•°æ®åº“

- [x] åˆ›å»ºæ­£ç¡®çš„è¡¨ç»“æ„ SQL
- [x] ä¿®æ”¹æ•°æ®åº“æ“ä½œå‡½æ•°
- [x] å®ç° JOIN æŸ¥è¯¢ï¼ˆbubble_noteï¼‰
- [x] æ”¯æŒæŒ‰ç±»å‹è¿‡æ»¤è®°å½•

### ä»£ç è´¨é‡

- [x] ç±»å‹æ³¨è§£å®Œæ•´
- [x] æ–‡æ¡£å­—ç¬¦ä¸²è¯¦ç»†
- [x] æ—¥å¿—è®°å½•å®Œå–„
- [x] å¼‚å¸¸å¤„ç†å¥å£®
- [x] å•ä¾‹æ¨¡å¼å®ç°

---

## ğŸ‰ æ€»ç»“

åœ°çµå¯¹è¯ç³»ç»Ÿ V2 å·²å®Œæˆæ ¸å¿ƒæ”¹è¿›ï¼š

### ä¸»è¦æˆå°±

1. **âœ… é€‚é…å®é™…éœ€æ±‚**ï¼šå®Œå…¨ç¬¦åˆå®é™…è¡¨ç»“æ„å’Œä¸šåŠ¡é€»è¾‘
2. **âœ… ä¼šè¯ç®¡ç†ä¼˜åŒ–**ï¼š30åˆ†é’Ÿè¶…æ—¶è‡ªåŠ¨å½’æ¡£ï¼Œç”¨æˆ·ä½“éªŒæ›´å¥½
3. **âœ… æ•°æ®å…³è”æ¸…æ™°**ï¼šé€šè¿‡ `bubble_id` å…³è”æ°”æ³¡å’Œå¯¹è¯è®°å½•
4. **âœ… å­˜å‚¨æ ¼å¼æ ‡å‡†**ï¼šJSON æ ¼å¼å­˜å‚¨ AI ç»“æœï¼Œæ˜“äºæ‰©å±•

### æŠ€æœ¯äº®ç‚¹

- ä¼šè¯è¶…æ—¶æœºåˆ¶ï¼ˆåå°ä»»åŠ¡å®šæœŸæ£€æŸ¥ï¼‰
- Bubble ID åŠ¨æ€å…³è”
- JSON æ ¼å¼çµæ´»å­˜å‚¨
- å¼‚æ­¥å½’æ¡£ä¸é˜»å¡å“åº”
- å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œé™çº§æ–¹æ¡ˆ

### å¯ç›´æ¥ä½¿ç”¨

æ‰€æœ‰ä»£ç å·²å®ç°å¹¶æµ‹è¯•é€šè¿‡ï¼Œå¯ç›´æ¥éƒ¨ç½²ä½¿ç”¨ï¼

---

**æ›´æ–°æ—¶é—´ï¼š** 2025-01-17
**ç‰ˆæœ¬ï¼š** V2.0
**çŠ¶æ€ï¼š** âœ… å®Œæˆå¹¶å¯ç”¨
